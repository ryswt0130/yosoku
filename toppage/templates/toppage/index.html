{% extends 'toppage/base.html' %}
{% block title %}
<title>発売日予測</title>
{% endblock %}

{% block content %}
{% load static %}
  <link rel="stylesheet" href="{% static "toppage/pickadate.js-3.6.2/lib/themes/main.css" %}">
  <link rel="stylesheet" href="{% static "toppage/pickadate.js-3.6.2/lib/themes/default.css" %}">
  <link rel="stylesheet" href="{% static "toppage/pickadate.js-3.6.2/lib/themes/default.date.css" %}">
  <!-- クラクシック版 -->
  <!-- <link rel="stylesheet" href="assets/css/classic.css">
  <link rel="stylesheet" href="assets/css/classic.date.css"> -->

<!--  <script src="https://code.jquery.com/jquery-1.12.4.js" integrity="sha256-Qw82+bXyGq6MydymqBxNPYTaUXXq7c8v3CwiYwLLNXU=" crossorigin="anonymous"></script>-->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

  <script src="{% static "toppage/pickadate.js-3.6.2/lib/picker.js" %}" type="text/javascript"></script>
  <script src="{% static "toppage/pickadate.js-3.6.2/lib/picker.date.js" %}" type="text/javascript"></script>
  <script src="{% static "toppage/pickadate.js-3.6.2/lib/legacy.js" %}" type="text/javascript"></script>
  <script src="{% static "toppage/pickadate.js-3.6.2/lib/ja_JP.js" %}" type="text/javascript"></script>
<!--  <script src="assets/js/main.js"></script>-->

<!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.0.0/fetch.js"></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.js"></script>


<!--  <div style="position:absolute; top:60px; left:10px; width:1000px; height:500px;">-->
  <div style="width:1000px; height:500px;">
  <canvas id="myLineChart"></canvas>
  </div>




  <form name="name_form" id="id_form1" action="/ajax/" method="POST" onsubmit="return false">
    <!-- <form name="name_form" action="/test_ajax_app/" method="POST"> -->
      {% csrf_token %}
      <input type="text" id="id_input_text" name="name_input_text" value="999.99">
      <input class="btn" type="submit">
    </form>

    <span id="id_div_ajax_response">
    </span>


    <section class="section">
      <div class="section__block section__block--scoped">
        <h3>demo</h3>
        <fieldset class="fieldset fieldset--demo">
          <div class="fieldset__wrapper" id="demo_div">
            <input id="demo" name="demo" class="fieldset__input js__datepicker" type="text" placeholder="Try me&hellip;">
            <button id="submit" type="button">aaa</button>
            <div id="result"></div>
          </div>
        </fieldset>
      </div>
    </section>

<!--    サーバーから予測日付一覧取得テスト-->
    <input id="test_get" type="text">
    <button id="test_get_button">test_get</button>
    <div id="test_get_result"></div>







  <h2>記事一覧   </h2>
    <div id="posts">
        {% for post in post_list %}
            <p>{{ post.title }}</p>
        {% endfor %}
    </div>

    <hr>

    <h2>記事の追加</h2>
    <form id="ajax-add-post" action="{% url 'toppage:ajax_post_add' %}" method="POST">
        <input type="text" id="id_title" required>
        <button type="submit" >送信</button>
        {% csrf_token %}
    </form>
<script>



window.onload = function() {
    const getCookie = name =>{
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')){
                    const [key, value] = cookie.trim().split('=');
                    if(key === name) {
                        return decodeURIComponent(value);
                    }
                }
            }
    };
    const csrftoken = getCookie('csrftoken');

    //all_yosoku = [{x: new Date("2020/10/10"), y: 10}]
    all_yosoku = []
    let text = {{ test_data|safe }}
    for(let i in text){
        all_yosoku.push({x: new Date(text[i][0]), y: text[i][1]});
    }


    $("#wrap").append(all_yosoku);

    let yosoku = 'zen3'
    //let url = `ajax_test_count_yosoku?yosoku=${yosoku}`
    let url = 'ajax_test_count_yosoku?series_name=zen3'
    all_yosoku_dd = [];

    fetch(url, {
        method: "GET",
        headers: {
           'X-CSRFToken': csrftoken,
        },
    })
    .then(response => {
        return response.json();
    })
/*    .then(text => {
        for(let i in text){
            let h = '<dt>'
            + text[i][0]
            + '</dt>'
            + '<dd>'
            + text[i][1]
            + '</dd>';
            $("#wrap").append(h);
            }
        })*/

        /*.then(text => {
          for(let i in text){
            let h = '<dt>' + text[i][0] + ',' + text[i][1] + '</dt>';
            $("#wrap").append(h);
          }
        })*/
        .then(text => {
          for(let i in text){
            all_yosoku_dd.push({x: new Date(text[i][0]), y: text[i][1]});
            //all_yosoku_dd.push({x: new Date("2020/10/10"), y: 10});
            myLineChart.update();
          }
        })









 //window.setTimeout(
 //() => {
  var ctx = document.getElementById("myLineChart");
  var myLineChart = new Chart(ctx, {
    type: 'line',
    //plugins: [annotation],
    data: {
      labels: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      datasets: [
        {
          label: '前製品から発売までの期間',
          //data: [0, 13.57, 14.6, 13],
          //data: [{x: new Date("2020/10/10"), y: 10}, {x: new Date("2020/12/12"), y: 12}],
          data: all_yosoku,
        //backgroundColor: ["rgba(255,165,0,0.8)", "rgba(255,165,0,0.8)", "rgba(255,165,0,0.8)", "rgba(0,0,0,0)",],
          backgroundColor: ["rgba(192,192,192,0.8)", "rgba(192,192,192,0.8)", "rgba(192,192,192,0.8)", "rgba(0,0,0,0)",],
          hoverBackgroundColor: ["rgba(255,165,0,1)", "rgba(255,165,0,1)", "rgba(255,165,0,1)", "rgba(255,165,0,0.3)"],
          borderColor: "rgba(0, 0, 0, 0.6)",
          borderWidth: [0, 0, 0, 1,],
          hoverBorderColor: [,,,"rgba(255,165,0,0.3)"],
          stack: 1,
        },
      ]
    },
    options: {
      title: {
        display: true,
        text: ''
      },
      scales: {
        yAxes: [{
          ticks: {
            suggestedMax: 14,
            suggestedMin: 0,
            stepSize: 2,
            callback: function(value, index, values){
              return  value +  ''
            }
          },
          scaleLabel: {
            display: true,
            labelString: '単位(ヶ月)'
          }
        }],
        xAxes: [{
          barPercentage: 0.4,
          type : 'time',
          time: {
              unit: 'month',
              displayFormats: {
                month: "M",
              },
              min: new Date('2020/01/01'),
              max: new Date('2020/12/31'),
          },
          tickes: {
            //source: 'labels',
          },
        }]
      },
      tooltips: {
        mode: 'x'
      },
      annotation: {
<!--        annotations: [{-->
<!--          type: "line",-->
<!--          id: 'horizontal-1',-->
<!--          mode: 'horizontal',-->
<!--          scaleID: 'y-axis-0',-->
<!--          value: 14,-->
<!--          borderColor: 'rgba(0, 0, 0, 0.6)',-->
<!--          borderWidth: 2,-->
<!--          borderDash: [50, 20],-->
<!--          //borderDashOffset: 10,-->
<!--          label: {-->
<!--          backgroundColor: 'rgba(0,0,0,0.8)',-->
<!--          fontFamily: "sans-serif",-->
<!--          fontSize: 12,-->
<!--          fontColor: "#fff",-->
<!--          enabled: true,-->
<!--          content: "平均期間 14ヶ月",-->
<!--          }-->
<!--        }]-->
      }
    }
  });
  //}, 1000)












};


  // Define a plugin to provide data labels
Chart.plugins.register({
    afterDatasetsDraw: function (chart, easing) {
        // To only draw at the end of animation, check for easing === 1
        var ctx = chart.ctx;

        chart.data.datasets.forEach(function (dataset, i) {
            var meta = chart.getDatasetMeta(i);
            if (!meta.hidden) {
                meta.data.forEach(function (element, index) {
                    // Draw the text in black, with the specified font
                    ctx.fillStyle = 'rgb(0, 0, 0)';

                    var fontSize = 16;
                    var fontStyle = 'normal';
                    var fontFamily = 'Helvetica Neue';
                    ctx.font = Chart.helpers.fontString(fontSize, fontStyle, fontFamily);

                    // Just naively convert to string for now
                    //var dataString = dataset.data[index].toString();

                    var rmd = dataset.data[index];
                    //if(dataset.label=='前製品から発売までの期間' && index==3) {
                    //仮
                    //rmd = rmd + 1
                    //}
                    var md = Math.floor(rmd);
                    var day = rmd - md;
                    day = Math.round(30 * day)
                    if(day > 0){
                    day = "と" + day + "日"
                    } else {
                    day = ""
                    }

                    if(dataset.label=='前製品から発売までの期間' && index==3) {
                    //var dataString = '（予測）' + md + "ヶ月" + day + '後に発売';
                    var dataString = '（予測）2020年9月に発売';
                    } else if(dataset.label=='前製品から発売までの期間') {
                    dataString =  md + "ヶ月" + day;
                    } else if(index==3) {
                    //dataString = '現在' + md + 'ヶ月' + day + '経過';
                    dataString = '発売まで13か月';
                    } else {
                    dataString = '';
                    }
                    console.log(dataset);
                    //console.log(chart.scales);


                    // Make sure alignment settings are correct
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    var padding = 5;
                    var position = element.tooltipPosition();
                    ctx.fillText(dataString, position.x, position.y - (fontSize / 2) - padding);
                });
            }
        });
    }
});























<!--$(function(){-->
<!--      $.getJSON("../json/sample.json", function(sample_list){-->
<!--        for(var i in sample_list){-->
<!--          var h = '<dt>'-->
<!--                + sample_list[i].list-->
<!--                + '</dt>'-->
<!--                + '<dd>'-->
<!--                + sample_list[i].content-->
<!--                + '</dd>';-->
<!--          $("dl#wrap").append(h);-->
<!--        }-->
<!--      });-->
<!--    });-->






  $(function() {
    $('#demo').pickadate({
      format: 'yyyy/mm/dd',
      min: [2020, 0, 1],
      max: [2020, 11, 31],
    });

    var date = new Date(2020, 02, 02);
    var picker = $('#demo').pickadate('picker');
    picker.set('select', date);



<!--    $('#submit').click(onClickSubmit);-->

<!--    function onClickSubmit(){-->
<!--      $('#submit_result').remove();-->
<!--      let demo = $('#demo').val();-->

<!--      if (demo!='') {-->
<!--        $('#result').after('<div id="submit_result" class="section__block"><p><strong>'+demo+'〜</strong><br>完了</p></div>');-->

<!--      } else {-->
<!--        $('#result').after('<div id="submit_result" class="section__block section__block&#45;&#45;notification-red"><p>やり直してください。</p></div>');-->
<!--      }-->
<!--    }-->

    $("#test_get_button").on('click', function() {

<!--        const getCookie = name =>{-->
<!--            if (document.cookie && document.cookie !== '') {-->
<!--                for (const cookie of document.cookie.split(';')){-->
<!--                    const [key, value] = cookie.trim().split('=');-->
<!--                    if(key === name) {-->
<!--                        return decodeURIComponent(value);-->
<!--                    }-->
<!--                }-->
<!--            }-->
<!--        };-->
<!--        const csrftoken = getCookie('csrftoken');-->


<!--        let yosoku = 'zen3'-->
<!--        //let url = `ajax_test_count_yosoku?yosoku=${yosoku}`-->
<!--        let url = 'ajax_test_count_yosoku?series_name=zen3'-->
<!--        fetch(url, {-->
<!--            method: "GET",-->
<!--            headers: {-->
<!--                'X-CSRFToken': csrftoken,-->
<!--            },-->
<!--        })-->
<!--        .then(response => {-->
<!--            return response.json();-->
<!--        })-->
<!--        .then(json => {-->
<!--            for(let i in json){-->
<!--              let h = '<dt>'-->
<!--                + json[i].yosoku_date-->
<!--                + '</dt>'-->
<!--                + '<dd>'-->
<!--                + json[i].date_count-->
<!--                + '</dd>';-->
<!--            $("#wrap").append(h);-->
<!--            }-->
<!--        })-->



<!--        .then(text => {-->
<!--            document.getElementById("test_get_result").innerHTML = text;-->
<!--            })-->

    })







     $("#submit").on('click', function() {
        // 一旦divを削除
        $('#__info-message').remove();
        // 通知領域を作成
        var difInfo = $('<div></div>')
            .attr('id', '__info-message')
            .css({
                'position' : 'absolute',
                'left' : 0,
                'width' : '100%',
                'z-index' : 100,
                'top' : 0,
                'text-align' : 'center',
                'opacity' : 0.8,
                'background-color' : '#eee',
                'font-size' : 'large'
            });
        // 作成したメッセージ領域を表示
        difInfo.html('<div style="padding:20px 15px;">完了しました！</div>');
        $('body').prepend(difInfo);

        // 1秒そのままにした後、slideUpして閉じる
        difInfo.delay(1000).slideUp('slow');




       const getCookie = name =>{
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')){
                    const [key, value] = cookie.trim().split('=');
                    if(key === name) {
                        return decodeURIComponent(value);
                    }
                }
            }
        };
        const csrftoken = getCookie('csrftoken');



    let demo = encodeURIComponent(document.getElementById('demo').value);
    //let demo = "2020/10/10"
    fetch('/ajax/', {
      method: "POST",
      body: `demo=${demo}`,
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
        'X-CSRFToken': csrftoken,
      },
    })
    .then(response => {
      return response.text();
    })
    .then(text => {
    document.getElementById("result").innerHTML = text;
    })

    });

  });




  // 送信ボタンで呼ばれる
        document.getElementById('ajax-add-post').addEventListener('submit', e => {
            // デフォルトのイベントをキャンセルし、ページ遷移しないように!
            e.preventDefault();


        const getCookie = name =>{
            if (document.cookie && document.cookie !== '') {
                for (const cookie of document.cookie.split(';')){
                    const [key, value] = cookie.trim().split('=');
                    if(key === name) {
                        return decodeURIComponent(value);
                    }
                }
            }
        };
        const csrftoken = getCookie('csrftoken');




            const url = '{% url "toppage:ajax_post_add" %}';
            const postArea = document.getElementById('posts');
            const title = encodeURIComponent(document.getElementById('id_title').value);
            fetch(url, {
                method: 'POST',
                body: `title=${title}`,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                    'X-CSRFToken': csrftoken,
                },
            }).then(response => {
                return response.json();
            }).then(response => {
                const p = document.createElement('p');
                p.textContent = response.title;
                postArea.insertBefore(p, postArea.firstChild);
            }).catch(error => {
                console.log(error);
            });
        });

  </script>
<div id = "T1"></div>
{% endblock %}
